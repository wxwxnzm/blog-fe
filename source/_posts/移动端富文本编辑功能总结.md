---
title: 移动端富文本功能技术总结(基于Eleditor)
---
## 背景：公司**微信端**和**app端**都需要加入移动端富文本编辑功能用于留言，支持图片/视频的上传。由于都是h5实现，遇到了问题在此总结下


### ios端：faskClick既不能触发click()也不能触发contenteditable的元素的focus
- 项目引入了faskClick以移除ios的300ms点击延迟,[Eleditor](https://github.com/Fixels/Eleditor)里上传图片是用[webuploader](https://github.com/Fixels/Eleditor/blob/master/demo/index.html#L168)实现的，在我们需要上传到阿里云的场景里不太合适，所以改写了一段源码，视频同理：
```
insertImage: function(e){
    $('.Eleditor-input-file-image').click(); // 选择文件
}
$('.Eleditor-input-file-image').on('change', function(e){
    uploadFilesToAliyun(e.target.files, function(data) { // 上传回调
        ...
        $('.Eleditor-input-file-image').val('');
    })
})
<input type="file" accept="image/*" class="Eleditor-input-file-image">

.Eleditor-input-file-image {
    visibility: hidden;
    opacity: 0;
    width: 0;
    height: 0;
}

```
- 然后问题来了，触发insertImage方法后并不会调用input的click，但是双击却可以，调试一番发现**只要是去掉faskClick的事件后单击就有效**

![fastclick使click()失效](http://geekjx.top/imgs/gifs/双击有效.gif
 "fastclick使click()失效")

#### click()方法解决：https://blog.csdn.net/kaosini/article/details/50561263
手动给它触发两次即可，改造代码：
```
var notNeed = FastClick.notNeeded(document.body); // boolean值
$.fn.triggerFastClick=function(){
    this.trigger("click");
    if(!notNeed){
        this.trigger("click");
    }
}
$('.Eleditor-textStyle-item-upImg').on('click', function(e) {
    if (FastClick) {
        $('.Eleditor-input-file-image').triggerFastClick();
    } else { // pc兼容
        $('.Eleditor-input-file-image').click();
    }
});
```
测试发现**微信浏览器的**ios和android都没问题 

#### 不能触发contenteditable的元素的focus解决： 增加一个needsclick类就可以了（https://segmentfault.com/q/1010000004278036）
![contenteditable元素双击才可触发](http://geekjx.top/imgs/gifs/contenteditable.gif
 "contenteditable元素双击才可触发")
```
 <div placeholder="点击输入内容"  class="textarea needsclick" contenteditable="true"></div>
 // 修改源码位置：https://github.com/Fixels/Eleditor/blob/master/Eleditor.js#L194

```

---

### android端: Android WebView 不支持 H5 input type="file" 
- 原因： [为了安全起见](https://blog.csdn.net/android_it/article/details/52538995)

#### 图片上传解决:只能让android同事给接口去主动触发选择图片（或者源生负责拦截input事件的点击，然后直接选择图片），很可能选择后的回调事件里还拿不到img的file结构，这边是选择base64，所以用base64再转为file再上传
```
var imgBase64ToFile = function(dataURI, imgName) { // 返回file
    var byteString = window.atob(dataURI.split(',')[1]);
    var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(ab);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    var fileType = 'image/' + imgName.split(".")[1];
    return new File([ia], imgName, { type: fileType });
}
window.nativeAfterImgPickerForAndroid = function(base64Url, imgName) { // 选择后android调用的方法(一起定义好的接口)
    var file = imgBase64ToFile(base64Url, imgName);
    uploadFilesToAliyun(file, function(data) { // 上传aliyun回调
        ...
    })
}
```

#### 视频上传解决： 选择视频和图片类似，但很可能拿到的是一个本地视频的地址，这个时候发现web已经没有办法转成files上传了，与android同事一起定义了4个方法（可以说是相当啰嗦了）：
```
window.nativeSelectVideo() // 主动调用选择视频,android定义
window.nativeGetVideoCallback = function(localPath){} // 拿到本地视频地址，web定义
window.nativeUploadFiles(localPath) // 主动通知android上传视频
window.nativeFilesAliPathCallback = function(videoUrl){} // 拿到阿里云视频地址，web定义
```
---

### 布局问题：Eleditor样式里全部都是px，项目用的是rem并且适配了高清屏(window.devicePixelRatio!==1)类似[手淘视口缩放下使用rem](https://juejin.im/entry/585b653061ff4b0058026ca4),需要从px转到rem，这里推荐用的是：[postcss-pxtorem](https://github.com/cuth/postcss-pxtorem)
##### 解决: 我是手动把base.css(https://github.com/Fixels/Eleditor/blob/master/layout/base.css)文件全部更换为rem的。。很蠢哈哈哈